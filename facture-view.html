<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title id="pageTitle">Facture</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      width: 794px;
      height: 1123px;
      background: #fff;
      color: #333;
      margin: 0 auto;
    }
    .facture-header { display: flex; justify-content: space-between; margin-bottom: 2rem; background: #fff; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; align-items: center; }
    .facture-header div { width: 48%; }
    #logo { height: 60px; margin-bottom: 1rem; }
    h1.title { text-align: center; margin-bottom: 0.5rem; font-size: 2rem; }
    h2.subtitle { text-align: center; margin-top: 0; font-weight: normal; color: #777; }
    .details { background: #fff; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 1rem; }
    .details strong { display: inline-block; width: 120px; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 1rem; }
    table th, table td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    table th { background: #eaeaea; }
    .totaux { margin-top: 1rem; float: right; text-align: right; }
    .totaux div { margin-bottom: 4px; }
    .notes { margin-top: 1rem; font-style: italic; background: #fff; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; clear: both; }
    .mention-tva { margin-top: 2rem; text-align: center; font-size: 0.9rem; color: #666; font-weight: bold; }
    .paye-le { margin-top: 0.5rem; float: right; font-size: 0.9rem; font-style: italic; display: none; margin-right: 0.5rem; }
    #btnPdf { display: block; margin: 2rem auto 0 auto; padding: 0.7rem 1.5rem; font-size: 1rem; background: #2a73e8; color: white; border: none; border-radius: 5px; cursor: pointer; clear: both; }
  #facture {
      width: 794px;
      height: 1123px;
      background: #fff;
      padding: 20px;
      box-sizing: border-box;
      margin: 0 auto;
    }
  </style>
</head>
<body class="viewer-body">
  <div class="viewer">
  <div class="viewer-toolbar">
    <div class="viewer-brand"><div class="viewer-brand-badge"></div>Panthère&nbsp;Informatique</div>
    <div class="viewer-actions">
      <button id="btnPdf" class="ui-btn primary">Exporter PDF</button>
      <button id="btnPrint" class="ui-btn">Imprimer</button>
      <button id="btnPng" class="ui-btn ghost">Télécharger PNG</button>
      <button id="btnTheme" class="ui-btn ghost" title="Thème">Thème</button>
    </div>
  </div>

  \1
    <h1 class="title">Facture</h1>
    <h2 class="subtitle">N° <span id="factureIdTitle"></span></h2>

    <div class="facture-header">
      <div id="societeInfos">Chargement société...</div>
      <div id="clientInfos">Chargement client...</div>
    </div>

    <div class="details">
      <div><strong>Date :</strong> <span id="factureDate"></span></div>
      <div><strong>Statut :</strong> <span id="factureStatut"></span></div>
      <div><strong>N° Facture :</strong> <span id="factureId"></span></div>
    </div>

    <table id="articlesTable">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Type</th>
          <th>Prix unit.</th>
          <th>Quantité</th>
          <th>Unité</th>
          <th>Remise (%)</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="totaux">
      <div>Sous-total HT : <span id="sousTotalHT">0.00</span> €</div>
      <div>TVA (<span id="tvaTaux">0</span>%) : <span id="tvaMontant">0.00</span> €</div>
      <div><strong>Total TTC :</strong> <span id="totalTTC">0.00</span> €</div>
    </div>

    <div class="paye-le" id="payeLe">✔️ Payée</div>

    <div class="notes" id="factureNotes"></div>
    <div class="mention-tva">TVA non applicable, art. 293B du CGI</div>
  </div>

  

  <script>
    const params = new URLSearchParams(window.location.search);
    let factureId = params.get("id");
    if (!factureId) {
      factureId = Math.floor(Date.now() / 1000).toString();
    }
    let nomClientPDF = "";

    async function chargerEtAfficherFacture() {
      try {
        const [resFactures, resClients, resSociete] = await Promise.all([
          fetch("data/factures.json"),
          fetch("data/clients.json"),
          fetch("data/societe.json")
        ]);

        const factures = await resFactures.json();
        const clients = await resClients.json();
        const societe = await resSociete.json();

        const facture = factures.find(f => f.id == factureId) || { id: factureId, statut: "en attente", articles: [] };
        const client = clients.find(c => c.nom === facture.client);
        nomClientPDF = client ? client.nom.replace(/\s+/g, "_") : "client";

        const tvaRate = parseFloat(societe.tva || 0);
        document.getElementById("tvaTaux").textContent = tvaRate;

        document.getElementById("factureId").textContent = facture.id;
        document.getElementById("factureIdTitle").textContent = facture.id;
        document.getElementById("pageTitle").textContent = "Facture N° " + facture.id;
        document.getElementById("factureDate").textContent = facture.date || new Date().toLocaleDateString();
        document.getElementById("factureStatut").textContent = facture.statut;
        document.getElementById("factureNotes").textContent = facture.notes || "";

        if (facture.statut.toLowerCase() === "payée") {
          document.getElementById("payeLe").style.display = "block";
        }

        document.getElementById("societeInfos").innerHTML = ` 
          <img id="logo" src="data/logo.png" alt="Logo entreprise"><br>
          <strong>${societe.nom}</strong><br>
          ${societe.adresse}<br>
          ${societe.cp}
          ${societe.ville}<br>
          ${societe.telephone}<br>
          ${societe.email}<br>
          SIRET : ${societe.siret}
        `;

        document.getElementById("clientInfos").innerHTML = client ? `
          <strong>${client.nom}</strong><br>
          ${client.adresse || ''}<br>
          ${client.email || ''}<br>
          ${client.telephone || ''}
        ` : "Client introuvable";

        const tbody = document.querySelector("#articlesTable tbody");
        tbody.innerHTML = "";

        let sousTotal = 0;
        facture.articles.forEach(a => {
          let remise = 0;
          if (a.remise) {
            remise = (a.remise / 100) * a.prix * a.quantite;
          }
          const total = (a.prix * a.quantite) - remise;
          sousTotal += total;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${a.nom}</td>
            <td>${a.type}</td>
            <td>${a.prix.toFixed(2)} €</td>
            <td>${a.quantite}</td>
            <td>${a.unite}</td>
            <td>${a.remise ? a.remise : '0'} %</td>
            <td>${total.toFixed(2)} €</td>
          `;
          tbody.appendChild(tr);
        });

        const tvaMontant = (sousTotal * tvaRate / 100);
        const totalTTC = sousTotal + tvaMontant;

        document.getElementById("sousTotalHT").textContent = sousTotal.toFixed(2);
        document.getElementById("tvaMontant").textContent = tvaMontant.toFixed(2);
        document.getElementById("totalTTC").textContent = totalTTC.toFixed(2);

      } catch (e) {
        console.error("Erreur chargement facture :", e);
        alert("Impossible de charger la facture.");
      }
    }

    document.getElementById("btnPdf").addEventListener("click", async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ format: 'a4', unit: 'pt' });
      const button = document.getElementById("btnPdf");
      button.style.display = "none";

      await html2canvas(document.getElementById("facture"), { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = 595;
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        doc.save(`facture_${factureId}_${nomClientPDF}.pdf`);
        button.style.display = "block";
      });
    });

    chargerEtAfficherFacture();
  </script>
</div>
  <script src="js/app.js"></script>
</body>
</html>
